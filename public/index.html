<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Échecs Atomiques Pro (Refactored)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Tes animations originales */
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    .shake-error { animation: shake 0.2s ease-in-out 0s 2; }
    .chess-piece { font-family: "Arial", sans-serif; user-select: none; }
    .coord { font-size: 10px; font-weight: bold; color: #94a3b8; display: flex; align-items: center; justify-content: center; }
    .coord-row { width: 20px; }
    .coord-col { height: 20px; }
  </style>
</head>
<body class="bg-slate-900">
  <div id="app"></div>

  <script type="module">
    import { ChessGame } from './src/core.js';
    import { AtomicRules } from './src/variants/atomic.js';
    import { ChessUI } from './src/ui.js';
    import { FirebaseManager } from './src/firebase.js';

    // 1. Initialisation
    const rules = new AtomicRules();
    const game = new ChessGame(rules);
    const ui = new ChessUI(game, 'app');
    const fb = new FirebaseManager();

    // 2. Gestion des clics (Pont entre UI et Game)
    window.onSquareClick = async (r, c) => {
        // Logique de sélection
        if (!ui.selectedSquare) {
            const piece = game.board[r][c];
            // On ne peut sélectionner que ses propres pièces
            if (piece && game.rules.getPieceColor(piece) === game.turn) {
                ui.selectedSquare = [r, c];
                ui.render();
            }
        } else {
            // Tentative de mouvement
            const from = ui.selectedSquare;
            const to = [r, c];
            
            // Si on clique sur la même case ou une pièce amie, on change la sélection
            const targetPiece = game.board[r][c];
            if (targetPiece && game.rules.getPieceColor(targetPiece) === game.turn) {
                 ui.selectedSquare = [r,c];
                 ui.render();
                 return;
            }

            const result = game.playMove(from, to);
            
            if (result.success) {
                ui.selectedSquare = null;
                if (result.explosions && result.explosions.length > 0) {
                    ui.triggerExplosion(result.explosions);
                } else {
                    ui.render();
                }
                
                // Sync Online
                if (fb.gameId) await fb.sendMove(game);

            } else {
                // Erreur visuelle (Shake)
                const grid = document.getElementById('chess-grid');
                grid.classList.add('shake-error');
                setTimeout(() => grid.classList.remove('shake-error'), 400);
                ui.selectedSquare = null;
                ui.render();
            }
        }
    };

    // 3. Boucle de jeu (Timer)
    game.startTimer(() => {
        ui.render(); // Met à jour l'affichage du chrono
    });

    // Premier rendu
    ui.render();

    // --- Fonctions globales pour les boutons Menu (à améliorer plus tard) ---
    window.startLocal = () => { /* déjà lancé par défaut */ };
    window.createOnlineGame = async () => {
        const code = await fb.createGame(game);
        alert("Code de partie : " + code);
        ui.render();
    };
    
  </script>
</body>
</html>